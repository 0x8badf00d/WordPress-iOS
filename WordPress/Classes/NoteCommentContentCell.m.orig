//
//  NoteCommentContentCell.m
//  WordPress
//
//  Created by Beau Collins on 1/7/13.
//  Copyright (c) 2013 WordPress. All rights reserved.
//

#import "NoteCommentContentCell.h"

@interface NoteCommentContentCell () <DTAttributedTextContentViewDelegate>

@end

@implementation NoteCommentContentCell

- (id)initWithStyle:(UITableViewCellStyle)style reuseIdentifier:(NSString *)reuseIdentifier {
    self = [super initWithStyle:style reuseIdentifier:reuseIdentifier];
    if (self) {
<<<<<<< HEAD
        self.attributedTextContextView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
        self.attributedTextContextView.edgeInsets = UIEdgeInsetsMake(10.f, 10.f, 20.f, 10.f);
        self.attributedTextContextView.shouldDrawLinks = NO;
        self.attributedTextContextView.delegate = self;
        self.attributedTextContextView.backgroundColor = [UIColor clearColor];
        [self.contentView addSubview:self.attributedTextContextView];
=======
        
        self.attributedTextView = [[DTAttributedTextContentView alloc] initWithFrame:CGRectMake(0.f, 0, 320.f, 40.f)];
        self.attributedTextView.autoresizingMask = UIViewAutoresizingFlexibleWidth | UIViewAutoresizingFlexibleHeight;
        self.attributedTextView.edgeInsets = UIEdgeInsetsMake(10.f, 10.f, 20.f, 10.f);
        self.attributedTextView.shouldDrawLinks = NO;
        self.attributedTextView.delegate = self;
        self.attributedTextView.backgroundColor = [UIColor clearColor];
        [self.contentView addSubview:self.attributedTextView];
>>>>>>> 6f9706547d7855e4cb42616471754729f4c0ee29
        self.backgroundView = [[UIView alloc] initWithFrame:self.bounds];
        self.backgroundView.backgroundColor = [UIColor whiteColor];
    }
    return self;
}


- (NSAttributedString *)attributedString {
    return self.attributedTextContextView.attributedString;
}

- (void)setAttributedString:(NSAttributedString *)attributedString {
    self.attributedTextContextView.attributedString = attributedString;
}

- (UIView *)attributedTextContentView:(DTAttributedTextContentView *)attributedTextContentView viewForAttributedString:(NSAttributedString *)string frame:(CGRect)frame {
<<<<<<< HEAD
	NSDictionary *attributes = [string attributesAtIndex:0 effectiveRange:NULL];

	DTLinkButton *button = [[DTLinkButton alloc] initWithFrame:frame];
	button.URL = [attributes objectForKey:DTLinkAttribute];
	button.GUID = [attributes objectForKey:DTGUIDAttribute];
	button.minimumHitSize = CGSizeMake(25, 25); // adjusts it's bounds so that button is always large enough

=======
//    NSDictionary *attributes = [string attributesAtIndex:0 effectiveRange:NULL];
//    
//    DTLinkButton *button = [[DTLinkButton alloc] initWithFrame:frame];
//    button.URL = [attributes objectForKey:DTLinkAttribute];
//    button.GUID = [attributes objectForKey:DTGUIDAttribute];
//    
//    NSMutableAttributedString *attributedString = [string mutableCopy];
//    NSRange range = NSMakeRange(0, [attributedString length]);
//	NSDictionary *stringAttributes = [NSDictionary dictionaryWithObject:(__bridge id)WP_LINK_COLOR.CGColor forKey:(id)kCTForegroundColorAttributeName];
//    
//    [attributedString addAttributes:stringAttributes range:range];
//    button.attributedString = attributedString;
//    
//    NSMutableAttributedString *highlightedString = [string mutableCopy];
//	NSDictionary *highlightedAttributes = [NSDictionary dictionaryWithObject:(__bridge id)[UIColor darkGrayColor].CGColor forKey:(id)kCTForegroundColorAttributeName];
//    
//    [highlightedString addAttributes:highlightedAttributes range:range];
//    
//    button.highlightedAttributedString = highlightedString;
//    
//    [button addTarget:self action:@selector(linkPushed:) forControlEvents:UIControlEventTouchUpInside];
//    return button;
//	
	NSDictionary *attributes = [string attributesAtIndex:0 effectiveRange:NULL];
	
	NSURL *URL = [attributes objectForKey:DTLinkAttribute];
	NSString *identifier = [attributes objectForKey:DTGUIDAttribute];
	
	
	DTLinkButton *button = [[DTLinkButton alloc] initWithFrame:frame];
	button.URL = URL;
	button.minimumHitSize = CGSizeMake(25, 25); // adjusts it's bounds so that button is always large enough
	button.GUID = identifier;
	
>>>>>>> 6f9706547d7855e4cb42616471754729f4c0ee29
	// get image with normal link text
	UIImage *normalImage = [attributedTextContentView contentImageWithBounds:frame options:DTCoreTextLayoutFrameDrawingDefault];
	[button setImage:normalImage forState:UIControlStateNormal];
	
	// get image for highlighted link text
	UIImage *highlightImage = [attributedTextContentView contentImageWithBounds:frame options:DTCoreTextLayoutFrameDrawingDrawLinksHighlighted];
	[button setImage:highlightImage forState:UIControlStateHighlighted];
	
<<<<<<< HEAD
	[button addTarget:self action:@selector(linkPushed:) forControlEvents:UIControlEventTouchUpInside];
=======
	// use normal push action for opening URL
	[button addTarget:self action:@selector(handleLinkTapped:) forControlEvents:UIControlEventTouchUpInside];
>>>>>>> 6f9706547d7855e4cb42616471754729f4c0ee29
	
	return button;
}

- (void)linkPushed:(id)sender {
    DTLinkButton *button = (DTLinkButton *)sender;
    [self sendUrlToDelegate:button.URL];
    
}

- (void)sendUrlToDelegate:(NSURL *)url {
    if ([self.delegate respondsToSelector:@selector(commentCell:didTapURL:)]) {
        [self.delegate commentCell:self didTapURL:url];
    }
}

- (void)displayAsParentComment {
    self.isParentComment = YES;
    
    NSMutableAttributedString *colorString = [self.attributedString mutableCopy];
    NSRange range = NSMakeRange(0, [colorString length]);
    NSDictionary *stringAttributes = [NSDictionary dictionaryWithObject:(__bridge id)[UIColor UIColorFromHex:0x464646].CGColor forKey:(id)kCTForegroundColorAttributeName];
    [colorString addAttributes:stringAttributes range:range];

    self.attributedTextContextView.attributedString = colorString;
    
    self.backgroundView.backgroundColor = COMMENT_PARENT_BACKGROUND_COLOR;
}

@end
